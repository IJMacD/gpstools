<!DOCTYPE html>
<html>
<head>
<title>GPS Tools</title>
<link rel="stylesheet" href="./css/bootstrap.min.css" />
<style>
  output {
    display: block;
  }
  progress {
    width: 940px;
  }
  small {
    color: #9DA0A4;
  }
  #elevation {
    display: none;
  }
  #log {
    border: 2px solid #9DA0A4;
    list-style: none;
    margin: 3px;
    min-height: 50px;
    padding: 10px;
  }
  #map {
    display: none;
    height: 400px;
  }
  #map img {
    max-width: initial;
  }
  #toggle-log {
    cursor: pointer;
  }
</style>
</head>
<body>
<div class="container">
    <h2>Input</h2>
    <label for="files">Choose GPS file</label>
    <input type="file" id="files" name="files" />
    <h2>Output</h2>
    <output id="gps"></output>
    <button id="show-map-btn" class="btn" disabled>Show Map</button>
    <button id="show-ele-btn" class="btn" disabled>Show Elevation</button>
    <button id="toggle-log" class="btn">Show Log</button>
    <button id="get-ele-btn" class="btn" disabled>Get Elevation</button>
    <button id="gen-gpx-btn" class="btn" disabled>Generate GPX</button><br>
    <progress value="0"></progress>
    <h2>Map</h2>
    <div id="map"></div>
    <h2>Elevation</h2>
    <canvas id="elevation" width="940" height="250">[No canvas support]</canvas>
    <h2>Log</h2>
    <ul id="log"></ul>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="http://openlayers.org/api/OpenLayers.js"></script>
<script src="./js/RGraph.common.core.js"></script>
<script src="./js/RGraph.line.js"></script>
<script>
GPSTools = {};
GPSTools.Format = {};
GPSTools.Format.GPX = function(){
    return {
        isValid: function (doc) {
            // This is not a jQuery object yet.
            if(!doc.find)
                doc = $(doc);

            return !!(doc.find('gpx').length);
        },
        parse: function (doc) {
            // This is not a jQuery object yet.
            if(!doc.find)
                doc = $(doc);

            var points = [];
            if(doc.find('trk')) {
                logging("GPX file with Track");
                pts = doc.find('trkpt');
                logging(pts.length + " track points");
                pts.each(function(i) {
                var item = $(this),
                    lat = item.attr('lat'),
                    lon = item.attr('lon'),
                    ele = parseFloat(item.find('ele').text()),
                    time = item.find('time').text();
                points.push(new GPSTools.Point(lat,lon,ele,time));
                });
                logging("Loaded " + points.length);
                return new GPSTools.Track(points);
            }
            else if(doc.find('rte')) {
                logging("GPX file with Route");
            }
            else if(doc.find('wpt')) {
                logging("GPX file with Waypoints");
            }
        },
        generate: function (track) {
            var doc = $.parseXML($('#gpx-tmpl').text()),
                gpx = $(doc).find('gpx'),
                metadata = gpx.find('metadata'),
                time = $('<time>', doc),
                trk = $('<trk>', doc),
                points = track.points,
                l = points.length,
                i = 0,
                p, trkpt, ele,
                hasTime = track.hasTime(),
                hasEle = track.hasElevation();
            time.text((new Date).toISOString());
            metadata.append(time);
            for(;i<l;i++) {
                p = points[i];
                trkpt = $('<trkpt>', doc);
                trkpt.attr({'lat': p.lat, 'lon': p.lon});
                if(hasEle) {
                    ele = $('<ele>', doc);
                    ele.text(p.ele);
                    trkpt.append(ele);
                }
                if(hasTime) {
                    time = $('<time>', doc);
                    time.text(p.time);
                    trkpt.append(time);
                }
                trk.append(trkpt);
            }
            gpx.append(trk);
            $('output').text((new XMLSerializer()).serializeToString(doc));
        }
    }
}();
GPSTools.Format.KML = function(){
    return {
        isValid: function (doc) {
            // This is not a jQuery object yet.
            if(!doc.find)
                doc = $(doc);

            return !!(doc.find('kml').length);
        },
        parse: function (doc) {
            // This is not a jQuery object yet.
            if(!doc.find)
                doc = $(doc);

            var lineString = doc.find('LineString'),
                c = lineString.find('coordinates').text().trim(),
                coords = c.split(" "),
                i = 0,
                l = coords.length,
                points = [],
                lle;
                logging(l + " track points");
            for(;i<l;i++) {
                lle = coords[i].split(",");
                points.push(new GPSTools.Point(lle[1], lle[0], lle[2]));
            }
            logging(points.length + " points loaded");
            return new GPSTools.Track(points);
        },
        generate: function (track) {}
    }
}();
GPSTools.Track = function (points) {
    this.points = points;
}
GPSTools.Track.prototype.hasTime = function (){
    return !!(this.points && this.points[0] && this.points[0].time);
}
GPSTools.Track.prototype.hasElevation = function (){
    return !!(this.points && this.points[0] && this.points[0].ele);
}
GPSTools.Track.prototype.getStart = function (){
    if(!this.start){
        if(this.points && this.points[0])
            this.start = new Date(this.points[0].time);
    }
    return this.start;
}
GPSTools.Track.prototype.getEnd = function (){
    if(!this.end){
        if(this.points && this.points[this.points.length-1])
            this.end = new Date(this.points[this.points.length-1].time);
    }
    return this.end;
}
GPSTools.Track.prototype.getDuration = function (){
    if(!this.duration)
        this.duration = this.getEnd() - this.getStart();
    return this.duration;
}
GPSTools.Track.prototype.getDistance = function (){
    if(!this.distance) {
        var dist  = 0,
            i = 1,
            l = this.points.length;
        logging("Calculating Distance");
        for(;i<l;i++){
            var p1 = this.points[i-1],
                p2 = this.points[i];
            dist += p1.distanceTo(p2);
        }
        logging("Calculation finished");
        this.distance = dist;
    }
    return this.distance;
}
GPSTools.Track.prototype.getElevation = function (){
    if(!this.elevation) {
        var ele = [],
            i = 0,
            l = this.points.length;
        logging("Collating elevation data");
        for(;i<l;i++)
            ele.push(this.points[i].ele);
        this.elevation = ele;
    }
    return this.elevation;
}
GPSTools.Point = function (lat,lon,ele,time) {
    this.lat = parseFloat(lat);
    this.lon = parseFloat(lon);
    this.ele = parseFloat(ele);
    this.time = time;
}
GPSTools.Point.prototype.distanceTo = function(){
    var R = 6371, // km
        toRad = function(n) {
            return n * Math.PI / 180;
        },
        toDeg = function(n) {
            return n * 180 / Math.PI;
        };
    return function(point) {
        var dLat = toRad(point.lat-this.lat),
            dLon = toRad(point.lon-this.lon),
            lat1 = toRad(this.lat),
            lat2 = toRad(point.lat),

            a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2),
            c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)),
            d = R * c;
        return d;
    }
}();
GPSTools.Map = function (){
    var map,
        osmLayer,
        lineLayer;
    return {
        create: function () {
            map = new OpenLayers.Map("map");
            osmLayer = new OpenLayers.Layer.OSM( "Simple OSM Map");
            lineLayer = new OpenLayers.Layer.Vector("Line Layer");
            map.addLayer(osmLayer);
            map.addLayer(lineLayer);
        },
        drawLine: function (points) {
            if(!map){
                $('#map').show();
                GPSTools.Map.create();
            }
            var olPoints = [],
                i,
                olLine,
                olBounds,
                olStyle,
                olFeature;
            logging("Drawing line");
            for(i=0;i<points.length;i++)
                olPoints.push(new OpenLayers.Geometry.Point(points[i].lon,points[i].lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()));
            olLine = new OpenLayers.Geometry.LineString(olPoints);
            logging("Conversion of points finished");
            olBounds = olLine.getBounds();
            olStyle = {
              strokeColor: '#0000ff',
              strokeOpacity: 0.5,
              strokeWidth: 5
            };
            olFeature = new OpenLayers.Feature.Vector(olLine, null, olStyle);
            lineLayer.addFeatures([olFeature]);
            map.zoomToExtent(olBounds);
        }
    }
}();
GPSTools.Util = function(){
    return {
        duration: function (time) {
            if(time < 1000)
                return time + ' milliseconds';
            time /= 1000;
            if(time < 60)
                return Math.floor(time) + ' seconds';
            time /= 60;
            if(time < 60){
                var m = Math.floor(time),
                    d = time - m,
                    s = Math.floor(d * 60);
                return m + ' minutes ' + s + ' seconds';
            }
            time /= 60;
            if(time < 24){
                var h = Math.floor(time),
                    d = time - h,
                    m = Math.floor(d * 60);
                return h + ' hours ' + m + ' minutes';
            }
            time /= 24;
            var dy = Math.floor(time),
                d = time - dy,
                h = Math.floor(d * 24);
            return dy + ' days ' + h + ' hours';
        }
    }
}();
  function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object

    // files is a FileList of File objects. List some properties.
    var output = [];
    if(files.length > 0) {
      f = files[0];
      logging("File selected");
      logging("Filename: \"" + f.name + "\"");
      logging("Size (bytes): " + f.size);
      if(f.size > 1024*1024)
        logging("Size is quite large, may be rejected");
      if(f.type) {
        logging("Type: " + f.type);
        // We can check a few types that it is definetly not going to be
        if( /^(image|audio|video)\//.test(f.type) ) {
          logging("Stopping for invalid type");
          return
        }
      }
      var reader = new FileReader();

      // Closure to capture the file information.
      reader.onload = (function(theFile) {
        return function(e) {
          // Render thumbnail.
          var doc = $($.parseXML( e.target.result ));
          if(GPSTools.Format.GPX.isValid(doc)) {
            logging("Found GPX file!");
            var track = GPSTools.Format.GPX.parse(doc);
          }
          else if(GPSTools.Format.KML.isValid(doc)) {
            logging("Found KML file!");
            var track = GPSTools.Format.KML.parse(doc);
          }
          else {
            logging("Unrecognised file type");
            return;
          }

            if(track.hasTime())
                $('output').html('Start: ' + track.getStart() + '<br>End: ' + track.getEnd() +
                    '<br>Duration: ' + GPSTools.Util.duration(track.getDuration()) +
                    '<br>Distance (km): ' + track.getDistance());
            else
                $('output').text('Distance (km): ' + track.getDistance());
            $('#show-map-btn').off('click').click(function(){
                GPSTools.Map.drawLine(track.points);
            }).removeAttr('disabled');
            $('#show-ele-btn').off('click').click(function(){
                $('#elevation').show();
                var data = track.getElevation(),
                    line = new RGraph.Line('elevation', data);
                line.Set('chart.background.barcolor1', 'white');
                line.Set('chart.background.barcolor2', 'white');
                line.Set('chart.background.grid.color', 'rgba(238,238,238,1)');
                line.Set('chart.colors', ['blue']);
                line.Set('chart.linewidth', 2);
                line.Set('chart.filled', true);
                line.Set('chart.hmargin', 5);
                line.Set('chart.gutter.left', 35);
                line.Draw();
            });
            if(track.hasElevation()) {
                logging("Track has elevation data");
                $('#show-ele-btn').removeAttr('disabled');
            }
            else {
                logging("Track does not have elevation data");
                $('#show-ele-btn').attr('disabled','');
                $('#get-ele-btn').off('click').on('click', function(){
                    $(this).attr('disabled','');
                    var i = 0,
                        points = track.points,
                        l = points.length,
                        baseURL = "http://ws.geonames.org/srtm3",
                        geo = {},
                        lat, lon, index,
                        progress = $('progress');
                    progress.attr('max', l);
                    for(;i<l;i++) {
                        lat = points[i].lat;
                        lon = points[i].lon;
                        index = lat + ":" + lon;
                        if(!geo[index]){
                            url = baseURL + "?lat=" + lat + "&lng=" + lon;
                            $.get(url, function(i,index){
                                return function(data){
                                    geo[index] = data;
                                    points[i].ele = geo[index];
                                    var val = progress.val() + 1;
                                    progress.val(val);
                                    if(val == l) {
                                        $('#show-ele-btn').removeAttr('disabled');
                                        progress.val(0);
                                    }
                                }
                            }(i,index));
                        }
                        else {
                            points[i].ele = geo[index];
                            var val = progress.val() + 1;
                            progress.val(val);
                            if(val == l) {
                                $('#show-ele-btn').removeAttr('disabled');
                                progress.val(0);
                            }
                        }
                    }
                }).removeAttr('disabled');
            }
            $('#gen-gpx-btn').off('click').on('click', function (){
                GPSTools.Format.GPX.generate(track);
            }).removeAttr('disabled');
        };
      })(f);

      // Read in the file as text.
      reader.readAsText(f);
    }
  }
  function logging(m) {
    $('#log').append('<li><small>' + (new Date()).toISOString() + "</small>: " + m);
  }
  document.getElementById('files').addEventListener('change', handleFileSelect, false);
  $('#log').hide();
  $('#toggle-log').click(function(){
    $('#log').toggle();
    self = $(this);
    self.text(self.text() == "Show Log" ? "Hide Log" : "Show Log");
  });
</script>
<script id="gpx-tmpl" type="text/plain">
<gpx version="1.1" creator="GPSTools" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd"><metadata></metadata></gpx>
</script>
</body>
</html>
