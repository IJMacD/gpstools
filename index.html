<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>GPS Tools</title>
<link rel="stylesheet" href="./css/bootstrap.min.css" />
<style>
  output {
    display: block;
  }
  progress {
    width: 940px;
  }
  small {
    color: #9DA0A4;
  }
  #elevation,
  #speed {
    display: none;
  }
  #log {
    border: 2px solid #9DA0A4;
    list-style: none;
    margin: 3px;
    min-height: 50px;
    padding: 10px;
  }
  #map {
    display: none;
    height: 400px;
  }
  #map img {
    max-width: none;
  }
  #map label {
    display: inline;
    margin-left: 3px;
  }
  #toggle-log {
    cursor: pointer;
  }
</style>
</head>
<body>
<div class="container">
    <h2>Input</h2>
    <label for="files">Choose GPS file</label>
    <input type="file" id="files" name="files" />
    <h2>Output</h2>
    <output id="gps"></output>
    <button id="toggle-log" class="btn">Show Log</button>
    <button id="get-ele-btn" class="btn" disabled>Get Elevation</button>
    <button id="gen-spd-btn" class="btn" disabled>Fake Speed</button>
    <button id="gen-gpx-btn" class="btn" disabled>Generate GPX</button><br>
    <progress value="0"></progress>
    <h2>Map</h2>
    <div id="map"></div>
    <h2>Elevation</h2>
    <canvas id="elevation" width="940" height="250">[No canvas support]</canvas>
    <h2>Gradient</h2>
    <canvas id="gradient" width="940" height="250">[No canvas support]</canvas>
    <h2>Speed</h2>
    <canvas id="speed" width="940" height="250">[No canvas support]</canvas>
    <h2>Log</h2>
    <ul id="log"></ul>
</div>
<div id="speedModal" class="modal hide fade">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Define Track Time</h3>
  </div>
  <div class="modal-body">
    <form class="form-horizontal">
        <div class="control-group">
            <label for="start_txt" class="control-label">Start:</label>
            <div class="controls">
                <input type="datetime" id="start_txt">
            </div>
        </div>
        <div class="control-group">
            <label for="end_txt" class="control-label">End:</label>
            <div class="controls">
                <input type="datetime" id="end_txt">
            </div>
        </div>
        <div class="control-group">
            <label for="duration_txt" class="control-label">Duration:</label>
            <div class="controls">
                <input type="text" id="duration_txt">
            </div>
        </div>
        <div class="control-group">
            <label for="distance_lbl" class="control-label">Distance:</label>
            <div class="controls">
                <span id="distance_lbl"></span> km
            </div>
        </div>
        <div class="control-group">
            <label for="speed_lbl" class="control-label">Speed:</label>
            <div class="controls">
                <span id="speed_lbl"></span> m s<sup>-1</sup>
            </div>
        </div>
    </form>
  </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal" aria-hidden="true">Close</a>
    <a href="#" class="btn btn-primary">Save changes</a>
  </div>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="http://openlayers.org/api/OpenLayers.js"></script>
<script src="./js/bootstrap.min.js"></script>
<script src="./js/RGraph.common.core.js"></script>
<script src="./js/RGraph.line.js"></script>
<script src="./js/RGraph.bar.js"></script>
<script src="./js/juration.js"></script>
<script>
var GPSTools = {};
GPSTools.Format = {};
GPSTools.Format.GPX = function(){
    return {
        isValid: function (doc) {
            // This is not a jQuery object yet.
            if(!doc.find)
                doc = $(doc);

            return !!(doc.find('gpx').length);
        },
        parse: function (doc) {
            // This is not a jQuery object yet.
            if(!doc.find)
                doc = $(doc);

            var points = [],
                pts;
            if(doc.find('trk').length) {
                logging("GPX file with Track");
                pts = doc.find('trkpt');
                logging(pts.length + " track points");
                pts.each(function(i) {
                var item = $(this),
                    lat = item.attr('lat'),
                    lon = item.attr('lon'),
                    ele = parseFloat(item.find('ele').text()),
                    time = item.find('time').text();
                points.push(new GPSTools.Point(lat,lon,ele,time));
                });
                logging("Loaded " + points.length);
                return new GPSTools.Track(points);
            }
            else if(doc.find('rte').length) {
                logging("GPX file with Route");
                pts = doc.find('rtept');
                logging(pts.length + " route points");
                pts.each(function(i) {
                var item = $(this),
                    lat = item.attr('lat'),
                    lon = item.attr('lon'),
                    ele = parseFloat(item.find('ele').text()),
                    time = item.find('time').text();
                points.push(new GPSTools.Point(lat,lon,ele,time));
                });
                logging("Loaded " + points.length);
                return new GPSTools.Track(points);
            }
            else if(doc.find('wpt').length) {
                logging("GPX file with Waypoints");
            }
        },
        generate: function (track) {
            var doc = $.parseXML($('#gpx-tmpl').text()),
                gpx = $(doc).find('gpx'),
                metadata = gpx.find('metadata'),
                time = $('<time>', doc),
                trk = $('<trk>', doc),
                points = track.points,
                l = points.length,
                i = 0,
                p, trkpt, ele,
                hasTime = track.hasTime(),
                hasEle = track.hasElevation();
            time.text((new Date()).toISOString());
            metadata.append(time);
            for(;i<l;i++) {
                p = points[i];
                trkpt = $('<trkpt>', doc);
                trkpt.attr({'lat': p.lat, 'lon': p.lon});
                if(hasEle) {
                    ele = $('<ele>', doc);
                    ele.text(p.ele);
                    trkpt.append(ele);
                }
                if(hasTime) {
                    time = $('<time>', doc);
                    time.text(p.time);
                    trkpt.append(time);
                }
                trk.append(trkpt);
            }
            gpx.append(trk);
            $('output').text((new XMLSerializer()).serializeToString(doc));
        }
    };
}();
GPSTools.Format.KML = function(){
    return {
        isValid: function (doc) {
            // This is not a jQuery object yet.
            if(!doc.find)
                doc = $(doc);

            return !!(doc.find('kml').length);
        },
        parse: function (doc) {
            // This is not a jQuery object yet.
            if(!doc.find)
                doc = $(doc);

            var lineString = doc.find('LineString'),
                c = lineString.find('coordinates').text().trim(),
                coords = c.split(" "),
                i = 0,
                l = coords.length,
                points = [],
                lle;
                logging(l + " track points");
            for(;i<l;i++) {
                lle = coords[i].split(",");
                points.push(new GPSTools.Point(lle[1], lle[0], lle[2]));
            }
            logging(points.length + " points loaded");
            return new GPSTools.Track(points);
        },
        generate: function (track) {}
    };
}();
GPSTools.Track = function (points) {
    this.points = points;
};
GPSTools.Track.prototype.hasTime = function (){
    return !!(this.points && this.points[0] && this.points[0].time);
};
GPSTools.Track.prototype.hasElevation = function (){
    return !!(this.points && this.points[0] && this.points[0].ele);
};
GPSTools.Track.prototype.getStart = function (){
    if(!this.start){
        if(this.points && this.points[0])
            this.start = new Date(this.points[0].time);
    }
    return this.start;
};
GPSTools.Track.prototype.getEnd = function (){
    if(!this.end){
        if(this.points && this.points[this.points.length-1])
            this.end = new Date(this.points[this.points.length-1].time);
    }
    return this.end;
};
/**
 * @return Duration in s
 */
GPSTools.Track.prototype.getDuration = function (){
    if(!this.duration)
        this.duration = (this.getEnd() - this.getStart()) / 1000;
    return this.duration;
};
GPSTools.Track.prototype.getDistance = function (){
    if(!this.distance) {
        var dist  = 0,
            i = 1,
            l = this.points.length;
        logging("Calculating Distance");
        for(;i<l;i++){
            var p1 = this.points[i-1],
                p2 = this.points[i];
            dist += p1.distanceTo(p2);
        }
        logging("Calculation finished");
        this.distance = dist;
    }
    return this.distance;
};
GPSTools.Track.prototype.getElevation = function (){
    if(!this.elevation) {
        var ele = [],
            i = 0,
            l = this.points.length;
        logging("Collating elevation data");
        for(;i<l;i++)
            ele.push(this.points[i].ele);
        this.elevation = ele;
    }
    return this.elevation;
};
GPSTools.Track.prototype.getGradient = function (){
    if(!this.gradient) {
        if(!this.hasElevation())
            throw "No Elevation data asccociated with this track";
        var grd = [],
            i = 1,
            l = this.points.length,
            p1, p2, dp,
            e1, e2, de,
            avg = [], c = 30,
            f = function(a,b){return a+b};
        logging("Collating gradient data");
        for(;i<l;i++){
            p1 = this.points[i-1];
            p2 = this.points[i];
            dp = p1.distanceTo(p2); // km
            e1 = p1.ele;
            e2 = p2.ele;
            de = e2 - e1; // m
            avg[i%c] = de / dp / 10; // %
            if(i>=c)
                grd.push(avg.reduce(f)/c);
        }
        this.gradient = grd;
    }
    return this.gradient;
};
GPSTools.Track.prototype.getSpeed = function (){
    if(!this.speed) {
        if (!this.hasTime())
            throw "No time data asccociated with this track";
        var spd = [],
            i = 1,
            l = this.points.length;
        logging("Collating speed data");
        for(;i<l;i++)
            spd.push(this.points[i].speedTo(this.points[i-1]));
        this.speed = spd;
    }
    return this.speed;
};
/**
 * @return Average speed in (m s^-1)
 */
GPSTools.Track.prototype.getAvgSpeed = function () {
    if(!this.avgSpeed) {
        this.avgSpeed = this.getDistance() / this.getDuration() * 1000;
    }
    return this.avgSpeed;
};
/**
 * @return Maximum speed in (m s^-1)
 */
GPSTools.Track.prototype.getMaxSpeed = function () {
    if(!this.maxSpeed) {
        var max = 0,
            i = 1,
            l = this.points.length;
        for(;i<l;i++)
            max = Math.max(this.points[i].speedTo(this.points[i-1]),max);
        this.maxSpeed = max;
    }
    return this.maxSpeed;
};
GPSTools.Point = function (lat,lon,ele,time) {
    this.lat = parseFloat(lat);
    this.lon = parseFloat(lon);
    this.ele = parseFloat(ele);
    this.time = time;
};
/**
 * @return Distance in km
 */
GPSTools.Point.prototype.distanceTo = function(){
    var R = 6371, // km
        toRad = function(n) {
            return n * Math.PI / 180;
        },
        toDeg = function(n) {
            return n * 180 / Math.PI;
        };
    return function(point) {
        var dLat = toRad(point.lat-this.lat),
            dLon = toRad(point.lon-this.lon),
            lat1 = toRad(this.lat),
            lat2 = toRad(point.lat),

            a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2),
            c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)),
            d = R * c;
        return d;
    };
}();
/**
 * @return Speed in (m s^-1)
 */
GPSTools.Point.prototype.speedTo = function(point) {
    var s = this.distanceTo(point) * 1000,
        t = Math.abs(new Date(this.time) - new Date(point.time)) / 1000;
    return s / t;
};
GPSTools.Map = function (){
    var map,
        osmLayer,
        cycleLayer,
        lineLayer;
    return {
        create: function () {
            map = new OpenLayers.Map("map", {'controls': [
                new OpenLayers.Control.Navigation(),
                new OpenLayers.Control.Zoom(),
                new OpenLayers.Control.LayerSwitcher()
            ]});
            osmLayer = new OpenLayers.Layer.OSM( "Simple OSM Map");
            cycleLayer = new OpenLayers.Layer.OSM("OpenCycleMap",
              ["http://a.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png",
               "http://b.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png",
               "http://c.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png"]);
            lineLayer = new OpenLayers.Layer.Vector("Line Layer");
            map.addLayer(osmLayer);
            map.addLayer(cycleLayer);
            map.addLayer(lineLayer);
        },
        drawLine: function (points) {
            if(!map){
                $('#map').show();
                GPSTools.Map.create();
            }
            var olPoints = [],
                i,
                olLine,
                olBounds,
                olStyle,
                olFeature;
            logging("Drawing line");
            for(i=0;i<points.length;i++)
                olPoints.push(new OpenLayers.Geometry.Point(points[i].lon,points[i].lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()));
            olLine = new OpenLayers.Geometry.LineString(olPoints);
            logging("Conversion of points finished");
            olBounds = olLine.getBounds();
            olStyle = {
              strokeColor: '#0000ff',
              strokeOpacity: 0.5,
              strokeWidth: 5
            };
            olFeature = new OpenLayers.Feature.Vector(olLine, null, olStyle);
            lineLayer.addFeatures([olFeature]);
            map.zoomToExtent(olBounds);
        }
    };
}();
GPSTools.Graph = (function(){
    var drawGraph = function(id, data, options){
        options = $.extend({
            color: 'black',
            filled: false
        }, options);

        $('#'+id).show();
        var graph;
        if(options.type == "bar")
            graph = new RGraph.Bar(id, data);
        else
            graph = new RGraph.Line(id, data);

        graph.Set('chart.background.barcolor1', 'white');
        graph.Set('chart.background.barcolor2', 'white');
        graph.Set('chart.background.grid.color', 'rgba(238,238,238,1)');
        graph.Set('chart.colors', [options.color]);
        graph.Set('chart.linewidth', 2);
        graph.Set('chart.filled', options.filled);
        graph.Set('chart.hmargin', 5);
        graph.Set('chart.gutter.left', 35);
        if(options.negative)
            graph.Set('chart.xaxispos', 'center');
        if(options.labels)
            graph.Set('chart.labels', options.labels);
        graph.Draw();
    };

    return {
        drawLine: function(id, data, color){
            if(typeof color != "object")
                color = {color: color, type:'line'};
            drawGraph(id, data, color);
        },
        drawFilled: function(id, data, color){
            if(typeof color != "object")
                color = {color: color,type:'line'};
            color.filled = true;
            drawGraph(id, data, color);
        },
        drawBar: function(id, data, color){
            if(typeof color != "object")
                color = {color: color,type:'bar'};
            color.filled = true;
            drawGraph(id, data, color);
        }
    }
}());
GPSTools.Util = function(){
    return {
        /**
         * @param time Time in seconds
         */
        duration: function (time) {
            var dy,d,h,m,s;
            time = Math.abs(time);
            if(time < 1)
                return (time*1000) + ' milliseconds';
            if(time < 60)
                return Math.floor(time) + ' seconds';
            time /= 60;
            if(time < 60){
                m = Math.floor(time);
                d = time - m;
                s = Math.floor(d * 60);
                return m + ' minutes ' + s + ' seconds';
            }
            time /= 60;
            if(time < 24){
                h = Math.floor(time);
                d = time - h;
                m = Math.floor(d * 60);
                return h + ' hours ' + m + ' minutes';
            }
            time /= 24;
            dy = Math.floor(time);
            d = time - dy;
            h = Math.floor(d * 24);
            return dy + ' days ' + h + ' hours';
        },
        /**
         * @param s Distance in km
         */
        convertToMiles: function (s) {
            return s * 0.62137119223733;
        },
        /**
         * @param v Speed in (m s^-1)
         */
        convertToMPH: function(v) {
            return v * 2.2369362920544;
        },
        /**
         * @param v Speed in (m s^-1)
         */
        convertToKPH: function(v) {
            return v * 3.6;
        }
    };
}();
  function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object

    // files is a FileList of File objects. List some properties.
    if(files.length > 0) {
      var f = files[0];
      logging("File selected");
      logging("Filename: \"" + f.name + "\"");
      logging("Size (bytes): " + f.size);
      if(f.size > 1024*1024)
        logging("Size is quite large, may be rejected");
      if(f.type) {
        logging("Type: " + f.type);
        // We can check a few types that it is definetly not going to be
        if( /^(image|audio|video)\//.test(f.type) ) {
          logging("Stopping for invalid type");
          return;
        }
      }
      var reader = new FileReader();

      // Closure to capture the file information.
      reader.onload = (function(theFile) {
        return function(e) {
          // Render thumbnail.
          var doc = $($.parseXML( e.target.result )),
              track;
          if(GPSTools.Format.GPX.isValid(doc)) {
            logging("Found GPX file!");
            track = GPSTools.Format.GPX.parse(doc);
          }
          else if(GPSTools.Format.KML.isValid(doc)) {
            logging("Found KML file!");
            track = GPSTools.Format.KML.parse(doc);
          }
          else {
            logging("Unrecognised file type");
            return;
          }

            if(track.hasTime())
            {
                showStats();
                $('#gen-spd-btn').hide();
                plotSpeed();
            }
            else{
                $('output').text('Distance (km): ' + track.getDistance());
                $('#gen-spd-btn').show().removeAttr('disabled');
            }

            GPSTools.Map.drawLine(track.points);

            $('#gen-spd-btn').off('click').click(function(){
                $(this).attr('disabled','');
                var speed = 10, // m s^-1,
                    distance = track.getDistance(), // km
                    duration = (distance / speed) * 1000, // s
                    end = new Date(),
                    start = new Date(end - duration*1000),
                    modal = $('#speedModal'),
                    start_txt = modal.find('#start_txt'),
                    end_txt = modal.find('#end_txt'),
                    duration_txt = modal.find('#duration_txt'),
                    distance_lbl = modal.find('#distance_lbl'),
                    speed_lbl = modal.find('#speed_lbl'),
                    hold = 'start';
                start_txt.val(start);
                end_txt.val(end);
                duration_txt.val(juration.stringify(duration));
                distance_lbl.text(distance.toFixed(2));
                speed_lbl.text(speed);
                start_txt.change(function(){
                    start = new Date(start_txt.val());
                    if(hold == 'duration'){
                        end = new Date(+start + duration*1000);
                        end_txt.val(end);
                    }
                    else{
                        duration = (end - start) / 1000;
                        duration_txt.val(juration.stringify(duration));
                        speed = (distance / duration) * 1000;
                        speed_lbl.text(speed.toFixed(1));
                    }
                    hold = 'start';
                });
                end_txt.change(function(){
                    end = new Date(end_txt.val());
                    if(hold == 'duration'){
                        start = new Date(end - duration*1000);
                        start_txt.val(start);
                    }
                    else{
                        duration = (end - start) / 1000;
                        duration_txt.val(juration.stringify(duration));
                        speed = (distance / duration) * 1000;
                        speed_lbl.text(speed.toFixed(1));
                    }
                    hold = 'end';
                });
                duration_txt.change(function(){
                    duration = juration.parse(duration_txt.val());
                    if(hold == 'end'){
                        start = new Date(end - duration*1000);
                        start_txt.val(start);
                    }
                    else{
                        end = new Date(+start + duration*1000);
                        end_txt.val(end);
                    }
                    speed = (distance / duration) * 1000;
                    speed_lbl.text(speed.toFixed(1));
                    hold = 'duration';
                });
                modal.modal().find('.btn-primary').click(function(){
                    modal.modal('hide');
                    var start = new Date(start_txt.val()),
                        end = new Date(end_txt.val()),
                        points = track.points,
                        duration = (+end - start) / 1000, // s
                        speed = distance / duration * 1000, // m s^-1,
                        points = track.points,
                        i = 1,
                        l = points.length,
                        cuml_dist = 0,
                        time, date;
                    track.points[0].time = start.toString();
                    for(;i<l;i++){
                        cuml_dist += points[i-1].distanceTo(points[i]); // km
                        time = cuml_dist / distance * duration; // s
                        date = new Date(+start + time*1000);
                        track.points[i].time = date.toISOString();
                    }
                    showStats();
                    plotSpeed();
                });
            });
            if(track.hasElevation()) {
                logging("Track has elevation data");
                $('#get-ele-btn').hide();
                plotElevation();
                plotGradient();
            }
            else {
                logging("Track does not have elevation data");
                $('#get-ele-btn').show().off('click').on('click', function(){
                    var i = 0,
                        points = track.points,
                        l = points.length,
                        baseURL = "http://ws.geonames.org/srtm3",
                        geo = {},
                        lat, lon, index,
                        progress = $('progress'),
                        getCallback = function(i,index){
                            return function(data){
                                geo[index] = Math.max(parseFloat(data),0);
                                points[i].ele = geo[index];
                                var val = progress.val() + 1;
                                progress.val(val);
                                if(val == l) {
                                    progress.val(0);
                                    plotElevation();
                                    plotGradient();
                                }
                            };
                        };
                    $(this).attr('disabled','');
                    progress.attr('max', l);
                    for(;i<l;i++) {
                        lat = points[i].lat;
                        lon = points[i].lon;
                        index = lat + ":" + lon;
                        if(!geo[index]){
                            var url = baseURL + "?lat=" + lat + "&lng=" + lon;
                            $.get(url, getCallback(i,index));
                        }
                        else {
                            points[i].ele = geo[index];
                            var val = progress.val() + 1;
                            progress.val(val);
                            if(val == l) {
                                progress.val(0);
                            }
                        }
                    }
                }).removeAttr('disabled');
            }
            $('#gen-gpx-btn').off('click').on('click', function (){
                GPSTools.Format.GPX.generate(track);
            }).removeAttr('disabled');

            function showStats() {
                $('output').html('Start: ' + track.getStart() + '<br>End: ' + track.getEnd() +
                    '<br>Duration: ' + GPSTools.Util.duration(track.getDuration()) +
                    '<br>Distance (km): ' + track.getDistance() +
                    '<br>Distance (mi): ' + GPSTools.Util.convertToMiles(track.getDistance()) +
                    '<br>Average Speed (km/h): ' + GPSTools.Util.convertToKPH(track.getAvgSpeed()) +
                    '<br>Maximum Speed (km/h): ' + GPSTools.Util.convertToKPH(track.getMaxSpeed()) +
                    '<br>Maximum Speed (mph): ' + GPSTools.Util.convertToMPH(track.getMaxSpeed())
                );
            }
            function plotSpeed () {
                GPSTools.Graph.drawLine('speed', track.getSpeed(), 'red');
            }
            function plotElevation(){
                GPSTools.Graph.drawFilled('elevation', track.getElevation(), 'blue');
            }
            function plotGradient(){
                GPSTools.Graph.drawLine('gradient', track.getGradient(), {color:'green',negative:true});
            }
        };
      })(f);

      // Read in the file as text.
      reader.readAsText(f);
    }
  }
  function logging(m) {
    $('#log').append('<li><small>' + (new Date()).toISOString() + "</small>: " + m);
  }
  document.getElementById('files').addEventListener('change', handleFileSelect, false);
  $('#log').hide();
  $('#toggle-log').click(function(){
    $('#log').toggle();
    var self = $(this);
    self.text(self.text() == "Show Log" ? "Hide Log" : "Show Log");
  });
</script>
<script id="gpx-tmpl" type="text/plain">
<gpx version="1.1" creator="GPSTools" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd"><metadata></metadata></gpx>
</script>
</body>
</html>
