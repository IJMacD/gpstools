<!DOCTYPE html>
<html>
<head>
<title>GPS Tools</title>
<link rel="stylesheet" href="./css/bootstrap.min.css" />
<style>
  small {
    color: #9DA0A4;
  }
  #log {
    border: 2px solid #9DA0A4;
    list-style: none;
    margin: 3px;
    min-height: 50px;
    padding: 10px;
  }
  #toggle-log {
    cursor: pointer;
  }
</style>
</head>
<body>
<div class="container">
    <h2>Input</h2>
    <label for="files">Choose GPS file</label>
    <input type="file" id="files" name="files" />
    <h2>Output</h2>
    <output id="gps"></output>
    <h2>Log</h2><small id="toggle-log">Show</small>
    <ul id="log"></ul>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script>
GPSTools = {};
GPSTools.Format = {};
GPSTools.Format.GPX = function(){
    return {
        isValid: function (doc) {
            // This is not a jQuery object yet.
            if(!doc.find)
                return parse($(doc));

            return !!(doc.find('gpx').length);
        },
        parse: function (doc) {
            // This is not a jQuery object yet.
            if(!doc.find)
                return parse($(doc));

            var points = [];
            if(doc.find('trk')) {
                logging("GPX file with Track");
                pts = doc.find('trkpt');
                logging(pts.length + " track points");
                pts.each(function(i) {
                var item = $(this),
                    lat = item.attr('lat'),
                    lon = item.attr('lon'),
                    ele = item.find('ele').text(),
                    time = item.find('time').text();
                points.push(new GPSTools.Point(lat,lon,ele,time));
                });
                logging("Converted " + points.length);
            }
            else if(doc.find('rte')) {
                logging("GPX file with Route");
            }
            else if(doc.find('wpt')) {
                logging("GPX file with Waypoints");
            }
        }
    }
}();
GPSTools.Point = function (lat,lon,ele,time) {
    this.lat = lat;
    this.lon = lon;
    this.ele = ele;
    this.time = time;
}
  function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object

    // files is a FileList of File objects. List some properties.
    var output = [];
    if(files.length > 0) {
      f = files[0];
      logging("File selected");
      logging("Filename: " + escape(f.name));
      logging("Size (bytes): " + f.size);
      if(f.size > 1024*1024)
        logging("Size is quite large, may be rejected");
      if(f.type) {
        logging("Type: " + f.type);
        // We can check a few types that it is definetly not going to be
        if( /^(image|audio|video)\//.test(f.type) ) {
          logging("Stopping for invalid type");
          return
        }
      }
      var reader = new FileReader();

      // Closure to capture the file information.
      reader.onload = (function(theFile) {
        return function(e) {
          // Render thumbnail.
          var doc = $($.parseXML( e.target.result ));
          if(GPSTools.Format.GPX.isValid(doc)) {
            logging("Found GPX file!");
            GPSTools.Format.GPX.parse(doc);
          }
          else
            logging("Unrecognised file type");
        };
      })(f);

      // Read in the image file as a data URL.
      reader.readAsText(f);
    }
  }
  function logging(m) {
    $('#log').append('<li><small>' + (new Date()).toISOString() + "</small>: " + m);
  }
  document.getElementById('files').addEventListener('change', handleFileSelect, false);
  $('#log').hide();
  $('#toggle-log').click(function(){
    $('#log').toggle();
    self = $(this);
    self.text(self.text() == "Show" ? "Hide" : "Show");
  });
</script>
</body>
</html>
